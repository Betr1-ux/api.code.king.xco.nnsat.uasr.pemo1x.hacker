<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>KING ADMIN - Codes</title>
  <style>
    body {
      margin: 0;
      font-family: "Cairo", Arial, sans-serif;
      background: #000;
      color: #0f0;
      text-align: center;
    }

    /* Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ */
    #loginScreen {
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #000428, #004e92);
      overflow: hidden;
    }

    .login-box {
      background: rgba(0, 0, 0, 0.7);
      padding: 40px 30px;
      border-radius: 15px;
      width: 320px;
      box-shadow: 0 0 25px rgba(0, 255, 128, 0.5);
      backdrop-filter: blur(10px);
      animation: fadeIn 1s ease;
    }

    .login-box h2 {
      margin-bottom: 5px;
      font-size: 26px;
      font-weight: bold;
      color: #39ff14;
    }

    .login-box p {
      font-size: 14px;
      color: #ccc;
      margin-bottom: 20px;
    }

    .login-box input {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      border: 1px solid #0f0;
      background: transparent;
      color: #0f0;
      border-radius: 8px;
      font-size: 16px;
      text-align: center;
      outline: none;
      transition: 0.3s;
    }
    .login-box input:focus {
      border-color: #39ff14;
      box-shadow: 0 0 8px #39ff14;
    }

    .login-box button {
      width: 100%;
      padding: 12px;
      margin-top: 15px;
      border: none;
      border-radius: 8px;
      background: linear-gradient(135deg, #39ff14, #00ff88);
      color: #000;
      font-weight: bold;
      font-size: 16px;
      cursor: pointer;
      transition: 0.3s;
    }
    .login-box button:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(0, 255, 128, 0.5);
    }

    #error {
      margin-top: 10px;
      color: #ff4d4d;
      display: none;
      font-weight: bold;
    }

    /* Ø²Ø± Ø§Ù„ØªÙ„Ø¬Ø±Ø§Ù… */
    .telegram-btn {
      display: inline-block;
      margin-top: 15px;
      padding: 10px 15px;
      border-radius: 50px;
      background: #0088cc;
      color: #fff;
      font-size: 14px;
      font-weight: bold;
      text-decoration: none;
      transition: 0.3s;
    }
    .telegram-btn:hover {
      background: #00aaff;
      box-shadow: 0 0 12px rgba(0, 136, 204, 0.7);
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }

    /* ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ */
    #mainApp {
      padding: 20px;
      color: #fff;
      background: #111;
      min-height: 100vh;
    }

    #mainApp h2 {
      color: #39ff14;
    }

    table {
      margin: 20px auto;
      border-collapse: collapse;
      width: 80%;
      max-width: 600px;
      background: #000;
      box-shadow: 0 0 15px rgba(0,255,128,0.3);
      border-radius: 8px;
      overflow: hidden;
    }

    table th, table td {
      border: 1px solid #39ff14;
      padding: 10px;
      text-align: center;
    }

    table th {
      background: #222;
      color: #39ff14;
    }

    table td {
      color: #fff;
    }

    #statusMsg {
      margin-top: 15px;
      font-weight: bold;
    }
  </style>
</head>
<body>

<!-- ÙˆØ§Ø¬Ù‡Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
<div id="loginScreen">
  <div class="login-box">
    <h2>ğŸ‘‘ KING ADMIN</h2>
    <p>ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</p>
    <input id="accessCode" type="password" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø³Ø±ÙŠ"/>
    <button id="loginBtn">Ø¯Ø®ÙˆÙ„</button>
    <div id="error">âŒ Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­</div>
    <a href="https://t.me/Loty122" target="_blank" class="telegram-btn">ğŸ“© ØªÙˆØ§ØµÙ„ Ø¹Ø¨Ø± Ø§Ù„ØªÙ„Ø¬Ø±Ø§Ù…</a>
  </div>
</div>

<!-- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ -->
<div id="mainApp" style="display:none;">
  <h2>Ù…Ø±Ø­Ø¨Ù‹Ø§ ÙƒÙŠÙ†Ø¬ ğŸ‘‘</h2>
  <div id="visitsBox">
    Ø¹Ø¯Ø¯ Ø²ÙŠØ§Ø±Ø§ØªÙƒ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© Ø§Ù„ÙŠÙˆÙ…: <span id="visitsLeft">0</span>
  </div>

  <label>Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯:</label>
  <input type="number" id="numCodes" value="5" min="1" max="100"><br>
  <label>Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ø§Øª Ù„ÙƒÙ„ ÙƒÙˆØ¯:</label>
  <input type="number" id="uses" value="1" min="1"><br>
  <button id="genBtn">ØªÙˆÙ„ÙŠØ¯</button>
  <button id="clearBtn">Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>

  <h3>Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…ØªØ§Ø­Ø©</h3>
  <table>
    <thead><tr><th>Ø§Ù„ÙƒÙˆØ¯</th><th>Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ø§Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©</th></tr></thead>
    <tbody id="codesTable"></tbody>
  </table>

  <div id="statusMsg"></div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getDatabase, ref, set, get, remove, runTransaction, onValue } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

  const CORRECT_CODE = "ASD2025XKASONA22250";
  const firebaseConfig = {
    apiKey: "AIzaSyDW4dAASi236YpSrebx7NkMBBNe6_rp5OI",
    authDomain: "gooa-6c940.firebaseapp.com",
    databaseURL: "https://gooa-6c940-default-rtdb.firebaseio.com",
    projectId: "gooa-6c940",
    storageBucket: "gooa-6c940.firebasestorage.app",
    messagingSenderId: "844888715239",
    appId: "1:844888715239:web:936dd5fdac8b46e0479742",
    measurementId: "G-66CL69F082"
  };

  const DAILY_VISITS = 100;
  let db;

  function showStatus(msg, color="lime"){
    const s = document.getElementById("statusMsg");
    s.innerText = msg;
    s.style.color = color;
  }

  document.getElementById("loginBtn").addEventListener("click", async () => {
    const val = document.getElementById("accessCode").value.trim();
    if(val !== CORRECT_CODE){
      document.getElementById("error").style.display = "block";
      return;
    }
    document.getElementById("loginScreen").style.display = "none";
    document.getElementById("mainApp").style.display = "block";
    const app = initializeApp(firebaseConfig);
    db = getDatabase(app);
    setupListeners();
    document.getElementById("genBtn").addEventListener("click", generateCodes);
    document.getElementById("clearBtn").addEventListener("click", clearAll);
    showStatus("ğŸ”„ Ø¬Ø§Ù‡Ø²");
  });

  function setupListeners(){
    onValue(ref(db, "visits"), (snap) => {
      if(snap.exists()){
        const v = snap.val();
        document.getElementById("visitsLeft").innerText = v.visitsLeft ?? DAILY_VISITS;
      } else {
        set(ref(db, "visits"), { visitsLeft: DAILY_VISITS, lastReset: Date.now(), usedToday: false })
          .catch(err=>showStatus("Ø®Ø·Ø£ Ø¥Ù†Ø´Ø§Ø¡ visits", "red"));
        document.getElementById("visitsLeft").innerText = DAILY_VISITS;
      }
    });

    onValue(ref(db, "codes"), (snap) => {
      const table = document.getElementById("codesTable");
      table.innerHTML = "";
      if(snap.exists()){
        const codes = snap.val();
        Object.keys(codes).forEach(c => {
          const row = `<tr><td>${c}</td><td>${codes[c].remaining}</td></tr>`;
          table.innerHTML += row;
        });
      }
    });
  }

  async function useVisits(count){
    try {
      const res = await runTransaction(ref(db, "visits"), (current) => {
        if(current === null) {
          return { visitsLeft: DAILY_VISITS - count, lastReset: Date.now(), usedToday: true };
        }
        if(typeof current.visitsLeft === 'undefined') current.visitsLeft = DAILY_VISITS;
        if(current.visitsLeft >= count){
          current.visitsLeft = current.visitsLeft - count;
          return { ...current, usedToday: true, lastReset: Date.now() };
        }
        return;
      });
      if(!res.committed){
        showStatus("âŒ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù†ØªÙ‡Øª");
        return false;
      }
      return true;
    } catch(err){
      showStatus("Ø®Ø·Ø£ ÙÙŠ Ø®ØµÙ… Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª", "red");
      return false;
    }
  }

  async function generateCodes(){
    const num = parseInt(document.getElementById("numCodes").value) || 0;
    const uses = parseInt(document.getElementById("uses").value) || 1;
    if(num <= 0){
      showStatus("Ø§Ø¯Ø®Ù„ Ø¹Ø¯Ø¯ ØµØ­ÙŠØ­ Ù„Ù„Ø£ÙƒÙˆØ§Ø¯", "red");
      return;
    }
    const ok = await useVisits(num);
    if(!ok) return;

    try {
      const snap = await get(ref(db, "codes"));
      const existing = new Set(snap.exists() ? Object.keys(snap.val()) : []);
      const newCodes = [];
      while(newCodes.length < num){
        const code = randomHex();
        if(!existing.has(code)){
          existing.add(code);
          newCodes.push(code);
        }
      }
      const promises = newCodes.map(c => set(ref(db, "codes/" + c), { remaining: uses }));
      await Promise.all(promises);
      showStatus(`âœ… ØªÙ… ØªÙˆÙ„ÙŠØ¯ ${newCodes.length} ÙƒÙˆØ¯`);
    } catch(err){
      showStatus("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙˆÙ„ÙŠØ¯", "red");
    }
  }

  async function clearAll(){
    try {
      await remove(ref(db, "codes"));
      showStatus("âœ… ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯");
    } catch(err){
      showStatus("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø³Ø­", "red");
    }
  }

  // Ø¯Ø§Ù„Ø© Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø¨Ø§Ù„Ø´ÙƒÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ XXXXX-XXXXX-XXXXX-XXXXX
  function randomHex(){
    const CHARS = "0123456789ABCDEF"; 
    let parts = [];
    for(let i=0; i<4; i++){
      let seg = "";
      for(let j=0; j<5; j++){
        seg += CHARS[Math.floor(Math.random()*CHARS.length)];
      }
      parts.push(seg);
    }
    return parts.join("-");
  }
</script>

</body>
  </html>
