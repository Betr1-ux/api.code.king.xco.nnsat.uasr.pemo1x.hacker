<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>KING ADMIN - Codes</title>
  <style>
    body {
      margin:0;
      font-family: "Segoe UI", Arial, sans-serif;
      background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
      color:#0f0;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    /* ÙˆØ§Ø¬Ù‡Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ */
    #loginScreen {
      background: rgba(0,0,0,0.7);
      padding: 30px 25px;
      border-radius: 16px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.8);
      width: 320px;
      text-align:center;
      animation: fadeIn 1s ease;
    }
    #loginScreen h2 {
      color:#0f0;
      margin-bottom: 20px;
      letter-spacing:1px;
    }
    #loginScreen input {
      width:100%;
      padding:10px;
      border-radius:8px;
      border:1px solid #0f0;
      background:transparent;
      color:#0f0;
      text-align:center; /* ÙŠØ®Ù„ÙŠ Ø§Ù„ÙƒØªØ§Ø¨Ø© ÙˆØ§Ù„Ù€ placeholder ÙÙŠ Ø§Ù„Ù†Øµ Ø¨Ø§Ù„Ù…Ù„ÙŠ */
      font-size:15px;
      margin-bottom:15px;
      outline:none;
    }
    #loginScreen button {
      width:100%;
      padding:10px;
      border:none;
      border-radius:8px;
      background:#0f0;
      color:#000;
      font-weight:bold;
      font-size:15px;
      cursor:pointer;
      transition:0.2s;
    }
    #loginScreen button:hover {
      background:#3f3;
      transform: scale(1.05);
    }
    #error {
      margin-top:10px;
      color:#f55;
      display:none;
      font-weight:bold;
    }

    /* Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù… */
    .telegram-link {
      display:inline-block;
      margin-top:15px;
      transition:0.2s;
    }
    .telegram-link img {
      width:40px;
      height:40px;
      border-radius:50%;
      box-shadow:0 0 8px rgba(0,0,0,0.6);
    }
    .telegram-link:hover {
      transform:scale(1.1);
    }

    /* Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ */
    #mainApp {
      display:none;
      padding:20px;
      width:100%;
      max-width:900px;
      margin:auto;
      color:#0f0;
    }
    h2,h3 { text-align:center; }

    input, button {
      padding:8px; margin:5px; border:none; border-radius:8px;
    }
    input {
      text-align:center; background:transparent; border:1px solid #0f0; color:#0f0;
    }
    button {
      background:#0f0; color:#000; font-weight:bold; cursor:pointer;
    }
    button:hover { background:#3f3; }
    table {
      border-collapse: collapse; width:100%; margin-top:15px;
    }
    th, td {
      border:1px solid #0f0; padding:6px; text-align:center;
    }
    #statusMsg { margin-top:10px; font-weight:bold; }

    @keyframes fadeIn {
      from {opacity:0; transform:translateY(20px);}
      to {opacity:1; transform:translateY(0);}
    }
  </style>
</head>
<body>

<div id="loginScreen">
  <h2>ğŸ”‘ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
  <input id="accessCode" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø¯Ø®ÙˆÙ„"/>
  <button id="loginBtn">Ø¯Ø®ÙˆÙ„</button>
  <div id="error">âŒ Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­</div>

  <!-- Ø²Ø± Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù… -->
  <a href="https://t.me/Loty122" target="_blank" class="telegram-link">
    <img src="https://upload.wikimedia.org/wikipedia/commons/8/82/Telegram_logo.svg" alt="Telegram">
  </a>
</div>

<div id="mainApp">
  <h2>Ù…Ø±Ø­Ø¨Ù‹Ø§ ÙƒÙŠÙ†Ø¬ ğŸ‘‘</h2>
  <div id="visitsBox">
    Ø¹Ø¯Ø¯ Ø²ÙŠØ§Ø±Ø§ØªÙƒ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© Ø§Ù„ÙŠÙˆÙ…: <span id="visitsLeft">0</span>
  </div>

  <label>Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯:</label>
  <input type="number" id="numCodes" value="5" min="1" max="100"><br>
  <label>Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ø§Øª Ù„ÙƒÙ„ ÙƒÙˆØ¯:</label>
  <input type="number" id="uses" value="1" min="1"><br>
  <button id="genBtn">ØªÙˆÙ„ÙŠØ¯</button>
  <button id="clearBtn">Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>

  <h3>Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…ØªØ§Ø­Ø©</h3>
  <table>
    <thead><tr><th>Ø§Ù„ÙƒÙˆØ¯</th><th>Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ø§Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©</th></tr></thead>
    <tbody id="codesTable"></tbody>
  </table>

  <div id="statusMsg"></div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getDatabase, ref, set, get, remove, runTransaction, onValue } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

  const CORRECT_CODE = "ASD2025XKASONA22250";
  const firebaseConfig = {
    apiKey: "AIzaSyDW4dAASi236YpSrebx7NkMBBNe6_rp5OI",
    authDomain: "gooa-6c940.firebaseapp.com",
    databaseURL: "https://gooa-6c940-default-rtdb.firebaseio.com",
    projectId: "gooa-6c940",
    storageBucket: "gooa-6c940.firebasestorage.app",
    messagingSenderId: "844888715239",
    appId: "1:844888715239:web:936dd5fdac8b46e0479742",
    measurementId: "G-66CL69F082"
  };

  const DAILY_VISITS = 100;
  let db;

  function showStatus(msg, color="lime"){
    const s = document.getElementById("statusMsg");
    s.innerText = msg;
    s.style.color = color;
  }

  document.getElementById("loginBtn").addEventListener("click", async () => {
    const val = document.getElementById("accessCode").value.trim();
    if(val !== CORRECT_CODE){
      document.getElementById("error").style.display = "block";
      return;
    }
    document.getElementById("loginScreen").style.display = "none";
    document.getElementById("mainApp").style.display = "block";
    const app = initializeApp(firebaseConfig);
    db = getDatabase(app);
    setupListeners();
    document.getElementById("genBtn").addEventListener("click", generateCodes);
    document.getElementById("clearBtn").addEventListener("click", clearAll);
    showStatus("ğŸ”„ Ø¬Ø§Ù‡Ø²");
  });

  function setupListeners(){
    onValue(ref(db, "visits"), (snap) => {
      if(snap.exists()){
        const v = snap.val();
        document.getElementById("visitsLeft").innerText = v.visitsLeft ?? DAILY_VISITS;
      } else {
        set(ref(db, "visits"), { visitsLeft: DAILY_VISITS, lastReset: Date.now(), usedToday: false });
        document.getElementById("visitsLeft").innerText = DAILY_VISITS;
      }
    });

    onValue(ref(db, "codes"), (snap) => {
      const table = document.getElementById("codesTable");
      table.innerHTML = "";
      if(snap.exists()){
        const codes = snap.val();
        Object.keys(codes).forEach(c => {
          const row = `<tr><td>${c}</td><td>${codes[c].remaining}</td></tr>`;
          table.innerHTML += row;
        });
      }
    });
  }

  async function useVisits(count){
    try {
      const res = await runTransaction(ref(db, "visits"), (current) => {
        if(current === null) {
          return { visitsLeft: DAILY_VISITS - count, lastReset: Date.now(), usedToday: true };
        }
        if(typeof current.visitsLeft === 'undefined') current.visitsLeft = DAILY_VISITS;
        if(current.visitsLeft >= count){
          current.visitsLeft = current.visitsLeft - count;
          return { ...current, usedToday: true, lastReset: Date.now() };
        }
        return;
      });
      if(!res.committed){
        showStatus("âŒ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù†ØªÙ‡Øª");
        return false;
      }
      return true;
    } catch(err){
      showStatus("Ø®Ø·Ø£ ÙÙŠ Ø®ØµÙ… Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª", "red");
      return false;
    }
  }

  async function generateCodes(){
    const num = parseInt(document.getElementById("numCodes").value) || 0;
    const uses = parseInt(document.getElementById("uses").value) || 1;
    if(num <= 0){
      showStatus("Ø§Ø¯Ø®Ù„ Ø¹Ø¯Ø¯ ØµØ­ÙŠØ­ Ù„Ù„Ø£ÙƒÙˆØ§Ø¯", "red");
      return;
    }
    const ok = await useVisits(num);
    if(!ok) return;

    try {
      const snap = await get(ref(db, "codes"));
      const existing = new Set(snap.exists() ? Object.keys(snap.val()) : []);
      const newCodes = [];
      while(newCodes.length < num){
        const code = randomHex();
        if(!existing.has(code)){
          existing.add(code);
          newCodes.push(code);
        }
      }
      const promises = newCodes.map(c => set(ref(db, "codes/" + c), { remaining: uses }));
      await Promise.all(promises);
      showStatus(`âœ… ØªÙ… ØªÙˆÙ„ÙŠØ¯ ${newCodes.length} ÙƒÙˆØ¯`);
    } catch(err){
      showStatus("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙˆÙ„ÙŠØ¯", "red");
    }
  }

  async function clearAll(){
    try {
      await remove(ref(db, "codes"));
      showStatus("âœ… ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯");
    } catch(err){
      showStatus("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø³Ø­", "red");
    }
  }

  function randomHex(){
    const CHARS = "0123456789ABCDEF";
    let parts = [];
    for(let i=0; i<4; i++){
      let seg = "";
      for(let j=0; j<5; j++){
        seg += CHARS[Math.floor(Math.random()*CHARS.length)];
      }
      parts.push(seg);
    }
    return parts.join("-");
  }
</script>

</body>
</html>
